GUIDES = [
  ["The Guide",
    "This is the Guide. It can show you all kinds of useful tips and explanations to help you on your adventure through the game.\nIt is especially useful when learning the mechanics that are new to Pokémon Vagabond.\n\nMore guides will be unlocked as you play through the game and you will be notified whenever you obtain a new guide.\n\nGuides can have several pages, so make sure to check the page number on the bottom right to see how many pages there are to a guide."],
  ["Changed Mechanics",
    "There are some game mechanics in Pokémon Vagabond that are changed from the official games. These sections are recommended to read as they explain new or changed mechanics:\n- Major Statuses\n   - Expire after a few turns\n   - Frostbite replaces Freeze\n   - Sleep reworked\n- Weather\n   - A new weather condition: Winds\n- Effort\n   - IVs and EVs replaced by ELs"],
  ["Partners",
    ""],
  ["Moves",
    ""],
  ["Types",
    "[type_chart]If you are playing a Pokémon Fan Game, I assume you know about weaknesses, resistances and immunities. A table of these can be seen above."],
  ["Stats",
    ""],
  ["Effort",
    "Effort Values (EVs) and Individual Values (IVs) are not used in Pokémon Vagabond. Instead a modified version of the Effort Level (EL) system from Pokemon Legends Arceus is used. The primary difference is that stats are upgraded only with items, not through battles.\n\nEffort Levels range from 0 to 10 for each stat and can be changed with these items:\n- Wings: Level up to 3\n- Vitamins: Level from 3 to 9\n- Gemstones: Level from 9 to 10\n- Berries: Lower level by 1\nHowever, all stats cannot be maxed...",
    "All stats can reach level 3, which is equivalent to an IV of 31. Past this point, stat increases will require Specialization Points (SP). All Pokémon have a total of 14 SP to use, which is enough to max out exactly two stats.\n\nIf you are unfamiliar with or do not care about the details, it is enough to know that raising Effort Levels raises stats, and that it is beneficial to only level a Pokémon's important stats past level 3.\n\nThe next page has direct conversions between ELs and IVs/EVs.",
    "Effort Level Conversion Table\n  EL  |  IV  |  EV  \n----|----|----\n   0   |   0   |   0\n   1    |  10  |   0\n   2   |  20  |   0\n   3   |  31  |   0\n   4   |  31  |  36\n   5   |  31  |  72\n   6   |  31  | 108\n   7   |  31  | 144\n   8   |  31  | 180\n   9   |  31  | 216\n  10  |  31  | 252"],
  ["Affinity Boosts",
    "All Pokémon have an Affinity listed next to their type. The affinity is determined by the species and form of the Pokémon. This defines what type of move is required to trigger an Affinity Boost. The Affinity of each Pokémon is also easily visible on the status bars during battle.",
    "How to Affinity Boost\n\nThe Pokémon that moves first on one side of the field can cause an Affinity Boost for other Pokémon on the same side of the field.\nAn Affinity Boost is activated when the faster Pokémon uses a move of the same type as the affinity of the slower Pokémon.\n\nFor the Affinity Boost to trigger, the triggering move needs to hit at least one opposing Pokémon for neutral or super effective damage.",
    "The Effect of Affinity Boosts\n\nWhen a Pokémon receives an Affinity Boost they will use their move directly after the triggering partner, regardless of speed and priority.\nThe move they use will also have its power increased by 30% and will always hit. Moves with less than 50% accuracy will not always hit.",
    "More About Affinity Boosts\n\nThere exists moves and abilities that take advantage of Affinity Boosts to gain various effects. Skiddo, Numel and Krabby all have access to abilities that make their Affinity Boosts stronger than other Pokémon.",
    "Bond Abilities\n\nA group of abilities that benefit from affinity boosts are called Bond abilities.\nThese abilities raise a specific stat whenever an Affinity Boost involving the Pokémon with the ability is triggered.\nIt is the Pokémon that received the Affinity Boost that has its stat raised. The Pokémon with the Bond ability is not the only one that can receive the stat boost from the ability."],
  ["Major Statuses",
    "There are five major status conditions a Pokémon may be inflicted with:\n- Poison (and Bad Poison)\n- Burn\n- Frostbite (and Freeze)\n- Sleep (reworked)\n- Paralysis\nPoison, Burn and Frostbite are healed passively after 5 turns, Bad Poison after 6 turns and Paralysis after 4 turns.\nSleep heals passively after 2 turns where the inflicted Pokémon tries to use a move.\nA new status condition cannot be applied before the current one is removed, even if the same status condition is being reapplied.",
    "Poison & Bad Poison\n\nPoison lasts 5 turns and damages a Pokémon by 1/8 of their total HP at the end of each turn.\n\nBad Poison lasts 6 turns and damages a Pokémon by 1/16 of their total HP at the end of the first turn, increasing by 1/16 each turn after.",
    "Burn & Frostbite\n\nBoth Burn and Frosbite last 5 turns and damage the inflicted Pokémon by 1/16 of their total HP at the end of each turn. Burn also halves the Pokémon's Attack, while Frostbite halves the Pokémon's Special Attack.\n\nFreeze\nThere are no moves that inflict Freeze, but it may appear for Boss specific effects. When inflicted with Freeze, a Pokémon has a 20% chance to thaw each turn. Freeze can also be cured by using or getting hit by some moves.",
    "Sleep\n\nSleep has been thoroughly reworked to account for Vagabond specific features like Affinity Boosts and Boss Battles.\n\nSleep lasts exactly 2 turns where the inflicted Pokémon tries to use a move. If a Pokémon is hit by a damaging move while asleep, it wakes up. Dream Eater and indirect damage do not wake sleeping Pokémon. A Pokémon will be immune to sleep the turn it wakes up, and then for as many turns as the Pokémon was asleep before waking up.",
    "Paralysis\n\nParalysis lasts 4 turns and halves the inflicted Pokémon's Speed. The turn Paralysis heals passively, the Pokémon will be paralyzed and can't move before being cured."],
  ["Weather",
    "Weather is one of the most impactful effects that can occur during battle. They have passive effects for certain types of Pokémon, and some moves and abilities benefit from their presence.\n\nThere are 5 base types of weather:\n- Winds\n- Sun\n- Rain\n- Sandstorm\n- Snow\n\nThe next pages explain these in detail.",
    "Winds\n\nThis is a new weather condition introduced in Pokémon Vagabond, and affects airborne Pokémon and some wind-based moves.\n\nIf a Pokémon is airborne, either by being Flying-type, the ability Levitate, or other effects such as Magnet Rise or an Air Balloon, they gain a 30% increase to their Speed.\n\nSome wind-based moves are powered up during Winds. This is mentioned in the description of the relevant moves.",
    "Sun & Rain\n\nThese weather conditions compete directly with each other. While Sun increases the power of Fire-type moves by 50% and lowers Water-type moves by 50%, Rain does the opposite. Many moves and abilities interact with these weather conditions.",
    "Sandstorm\n\nDuring a Sandstorm, all Pokémon that are not Rock-, Steel- or Ground-type are damaged for 1/16 of their total HP each turn. Rock-types also have their Special Defense boosted by 50%.\n\nSnow & Hail\n\nIce-types gain a 50% boost to their Defense during Snow. Hail is an intense variant of Snow that damages non-Ice-type Pokémon for 1/16 of their total HP each turn in addition to the other effects."],
  ["Terrain",
    ""],
  ["Quests",
    ""],
  ["Jobs",
    "Around the region you may find various jobs you can take on. These jobs offer unique activities and benefits, making them highly beneficial to your journey. Ranking up in jobs will grant you even stronger benefits. You can keep track of your jobs as well as their ranks and active benefits from the Trainer menu.\n\nYour first job is for the G.P.O. and allows you to accept smaller tasks from the receptionist to receive rewards. If you do enough tasks, your G.P.O. job rank will increase, and you will unlock more difficult tasks for more valuable rewards!"],
  ["Berry Bushes",
    "While exploring nature you might encounter berry bushes with various berries to harvest.\nYou can find more than just berries from these bushes. If you are lucky, you can find other plant related items in addition to the berries you harvest.\n\nSurely there should be ways to find these items more efficiently, but who could teach you about the intricacies of the sweet and mysterious world of berries?"],
  ["Berry Bushes 2",
    "[directional_harvesting]Directional Harvesting is a technique that allows you to influence what items you get from a berry bush. This is done by harvesting the berries from a specific direction.\nFrom the left or right you get more berries.\nFrom the top you are much more likely to get herbs and powders.\nFrom the bottom you are much more likely to get mushrooms, roots and seeds."],
  ["Mining",
    ""],
  ["Fishing",
    "[fishing_1]When you use the Fishing Rod while facing water, the menu shown in the above picture will appear. There will be a countdown of 3 seconds before the hooking game starts.\n\nYou need to move the top green bar to keep the moving Pokémon inside it. While inside, the progress bar below will increase, but outside it will decrease. If the bar is filled, you hook the Pokémon, but if it reaches the bottom you fail. This bar always starts at 25%.",
    "Fish Behaviors\n\nHooked Pokémon can have one of four behaviors depending on species:\n- Passive: Sometimes stands still\n- Normal: Always moving\n- Sudden: Moves sometimes, but fast\n- Aggressive: Occassionally stuns you\n\nThey also have three species-dependant stats:\n- Stamina: Time it takes to fill the progress bar\n- Speed: How fast the Pokémon moves\n- Strength: Reduces the size of the green bar"]
]

class KeybindSprite < SpriteWrapper 

  attr_accessor :baseColor
  attr_accessor :shadowColor

  def initialize(input, name, x, y, viewport)
    super(viewport)
    @input = input
    @name  = name
    @baseColor = Color.new(252,252,252)
    @shadowColor = Color.new(0,0,0)
    self.bitmap = Bitmap.new(224, 28)
    self.x = x
    self.y = y
    @keybind_icons = AnimatedBitmap.new("Graphics/Pictures/keybinds")
    self.refresh
  end

  def name=(value)
    if @name != value
      @name = value
      self.refresh
    end
  end

  def refresh
    self.bitmap.clear
    if @input.is_a?(Array)
      x = 0
      for i in @input
        self.bitmap.blt(x, 0, @keybind_icons.bitmap, $Keybinds.rect(i))
        x += 28
      end
      textpos = [[@name,x+6,4,0,@baseColor,@shadowColor,true]]
      pbSetSmallFont(self.bitmap)
      pbDrawTextPositions(self.bitmap, textpos)
    else
      self.bitmap.blt(0, 0, @keybind_icons.bitmap, $Keybinds.rect(@input))
      textpos = [[@name,34,4,0,@baseColor,@shadowColor,true]]
      pbSetSmallFont(self.bitmap)
      pbDrawTextPositions(self.bitmap, textpos)
    end
  end

  def dispose
    @keybind_icons.dispose
    super
  end

end

class Window_Guide < Window_DrawableCommand
  def initialize(items,x,y,width,height,viewport=nil)
    @items = items
    super(x, y, width, height, viewport)
    @selarrow=AnimatedBitmap.new("Graphics/Pictures/Guide/cursor")
    @baseColor=Color.new(88,88,80)
    @shadowColor=Color.new(168,184,184)
    self.windowskin=nil
  end

  def itemCount
    return @items.length+1
  end

  def item
    return self.index >= @items.length ? 0 : @items[self.index]
  end

  def drawItem(index, count, rect)
    textpos=[]
    rect=drawCursor(index,rect)
    ypos=rect.y
    if index == count - 1
      textpos.push([_INTL("CANCEL"),rect.x,ypos,false,
         self.baseColor,self.shadowColor])
    else
      itemname=@items[index][0]
      textpos.push([itemname,rect.x,ypos,false,self.baseColor,self.shadowColor])
    end
    pbDrawTextPositions(self.contents,textpos)
  end
end

class GuideScreen

  def pbStartGuideScreen(start_guide=nil)
    @viewport = Viewport.new(0, 0, Graphics.width, Graphics.height)
    @viewport.z = 99999
    @sprites = {}
    @guides = []
    for g in GUIDES
      # Add check for game variable
      @guides.push(g) if pbHasGuide(g[0]) || ($DEBUG && Input.press?(Input::CTRL))
    end
    @index = 0
    if start_guide
      pbAddGuide(start_guide)
      for i in 0...@guides.length
        if @guides[i][0] == start_guide
          @index = i
          break
        end
      end
    else
      for i in 0...@guides.length
        if @guides[i][0] == $game_variables[Supplementals::LAST_GUIDE]
          @index = i
          break
        end
      end
    end
    @page  = 0
    @width = Graphics.width * 2 / 5
    @height = Graphics.height * 3 / 4
    @text_x = 236
    @text_y = 12
    @text_width = Graphics.width - 240
    @text_height = Graphics.height - 48
    @image_max_width = @text_width * 1.0
    @image_max_height = Graphics.height * 3.0 / 4.0
    @sprites["background"] = IconSprite.new(0, 0, @viewport)
    @sprites["background"].setBitmap("Graphics/Pictures/Guide/bg")
    @sprites["itemlist"]=Window_Guide.new(@guides, -12, 12, 264, Graphics.height - 56)
    @sprites["itemlist"].viewport = @viewport
    @sprites["itemlist"].index = @index
    @sprites["itemlist"].baseColor = Color.new(252, 252, 252)
    @sprites["itemlist"].shadowColor = Color.new(0, 0, 0)
    @sprites["itemlist"].refresh
    @sprites["textwindow"] = Window_UnformattedTextPokemon.new("")
    @sprites["textwindow"].viewport=@viewport
    @sprites["textwindow"].visible = true
    @sprites["textwindow"].letterbyletter = false
    @sprites["textwindow"].x = @text_x
    @sprites["textwindow"].y = @text_y
    @sprites["textwindow"].width = @text_width
    @sprites["textwindow"].height = @text_height
    @sprites["textwindow"].baseColor = Color.new(252, 252, 252)
    @sprites["textwindow"].shadowColor = Color.new(0, 0, 0)
    @sprites["textwindow"].windowskin=nil
    @sprites["overlay"] = Sprite.new(@viewport)
    @sprites["overlay"].bitmap = Bitmap.new(Graphics.width, Graphics.height)
    pbSetSmallFont(@sprites["overlay"].bitmap)
    @sprites["image"] = IconSprite.new(0, 0, @viewport)
    @sprites["image"].x = @sprites["textwindow"].x + @sprites["textwindow"].width / 2
    @sprites["image"].y = @sprites["textwindow"].y + 6
    @sprites["control_exit"] = KeybindSprite.new(Input::BACK, "Exit", 46, Graphics.height - 36, @viewport)
    @sprites["control_hint"] = KeybindSprite.new([Input::UP, Input::DOWN], "Select Hint", 130, Graphics.height - 36, @viewport)
    @sprites["control_page"] = KeybindSprite.new([Input::LEFT, Input::RIGHT], "Change Page", 302, Graphics.height - 36, @viewport)
    self.refresh
    pbFadeInAndShow(@sprites)
  end

  def refresh
    item = @sprites["itemlist"].item
    $game_variables[Supplementals::LAST_GUIDE] = item[0]
    @sprites["overlay"].bitmap.clear
    page_text = _INTL("Page {1}/{2}", @page+1, (item == 0) ? 1 : item.length-1)
    textpos = [
      [page_text, Graphics.width-98, Graphics.height-74, 0, Color.new(252,252,252), Color.new(0,0,0), true]
    ]
    pbDrawTextPositions(@sprites["overlay"].bitmap, textpos)
    if item == 0
      @sprites["image"].visible = false
      @sprites["textwindow"].y = @text_y
      @sprites["textwindow"].height = @text_height
      @sprites["textwindow"].text = "Select this option to close the Guide menu."
    else
      item = item[1 + @page]
      if item[0...1] == "["
        @sprites["image"].visible = true
        image = item[1...item.index("]")]
        item = item[item.index("]")+1...item.length]
        @sprites["image"].setBitmap(_INTL("Graphics/Pictures/Guide/{1}", image))
        @sprites["image"].ox = @sprites["image"].bitmap.width / 2
        zoom = [1.0, @image_max_width/@sprites["image"].bitmap.width, @image_max_height/@sprites["image"].bitmap.height].min
        @sprites["image"].zoom_x = zoom
        @sprites["image"].zoom_y = zoom
        @sprites["textwindow"].y = @text_y + @sprites["image"].bitmap.height * zoom
        @sprites["textwindow"].height = @text_height - @sprites["image"].bitmap.height * zoom
        @sprites["textwindow"].text = item
      else
        @sprites["image"].visible = false
        @sprites["image"].setBitmap(nil)
        @sprites["textwindow"].y = @text_y
        @sprites["textwindow"].height = @text_height
        @sprites["textwindow"].text = item
      end
    end
  end

  def update
    pbUpdateSpriteHash(@sprites)
    @viewport.update
    if @index != @sprites["itemlist"].index
      @index = @sprites["itemlist"].index
      @page = 0
      self.refresh
    end
  end

  def pbChooseOption
    loop do
      Graphics.update
      Input.update
      self.update
      new_page = @page
      if Input.trigger?(Input::LEFT)
        new_page -= 1
        if new_page < 0
          page_count = @sprites["itemlist"].item.length - 1
          new_page = page_count - 1
        end
      elsif Input.trigger?(Input::RIGHT)
        new_page += 1
        page_count = @sprites["itemlist"].item.length - 1
        if new_page == page_count
          new_page = 0
        end
      elsif Input.trigger?(Input::BACK)
        return -1
      elsif Input.trigger?(Input::USE)
        if @index == @sprites["itemlist"].itemCount - 1
          return -1
        end
      end
      if new_page != @page
        @page = new_page
        self.refresh
      end
    end
  end

  def pbEndGuideScreen
    pbFadeOutAndHide(@sprites)
    pbDisposeSpriteHash(@sprites)
    @viewport.dispose
  end

end

def pbInitGuides
  guides = {}
  guides["The Guide"] = true
  guides["Changed Mechanics"] = true
  guides["Moves"] = true
  guides["Types"] = true
  guides["Stats"] = true
  guides["Effort"] = true
  guides["Major Statuses"] = true
  guides["Weather"] = true
  guides["Terrain"] = true
  $game_variables[Supplementals::GUIDE_LIST] = guides
end

def pbHasGuide(guide)
  pbInitGuides if $game_variables[Supplementals::GUIDE_LIST].is_a?(Numeric)
  return $game_variables[Supplementals::GUIDE_LIST][guide]
end

def pbAddGuide(guide, silent = false)
  pbInitGuides if $game_variables[Supplementals::GUIDE_LIST].is_a?(Numeric)
  if !$game_variables[Supplementals::GUIDE_LIST][guide]
    $game_variables[Supplementals::GUIDE_LIST][guide] = true
    $game_variables[Supplementals::NEW_GUIDE] = guide
    pbToast(TopWindowToast.new(_INTL("New Guide Available\n{1}", guide))) if !silent
  end
end

def pbGuide(guide)
  pbAddGuide(guide, true)
  pbFadeOutIn {
    pbStartGuideScreen(guide)
  }
end

def pbStartGuideScreen(guide=nil)
  guide_screen = GuideScreen.new
  guide_screen.pbStartGuideScreen(guide)
  loop do
    option = guide_screen.pbChooseOption
    break if option == -1
  end
  guide_screen.pbEndGuideScreen
end

MenuHandlers.add(:pause_menu, :guide, {
  "name"      => _INTL("Guide"),
  "order"     => 65,
  "condition" => proc { next $game_variables },
  "effect"    => proc { |menu|
    menu.pbHideMenu
    pbStartGuideScreen
    menu.pbRefresh
    menu.pbShowMenu
    next false
  }
})