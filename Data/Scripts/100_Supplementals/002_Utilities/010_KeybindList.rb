module InputCode
  UNKNOWN = 0,
  A = 4,
  B = 5,
  C = 6,
  D = 7,
  E = 8,
  F = 9,
  G = 10,
  H = 11,
  I = 12,
  J = 13,
  K = 14,
  L = 15,
  M = 16,
  N = 17,
  O = 18,
  P = 19,
  Q = 20,
  R = 21,
  S = 22,
  T = 23,
  U = 24,
  V = 25,
  W = 26,
  X = 27,
  Y = 28,
  Z = 29,
  NUM1 = 30,
  NUM2 = 31,
  NUM3 = 32,
  NUM4 = 33,
  NUM5 = 34,
  NUM6 = 35,
  NUM7 = 36,
  NUM8 = 37,
  NUM9 = 38,
  NUM0 = 39,
  RETURN = 40,
  ESCAPE = 41,
  BACKSPACE = 42,
  TAB = 43,
  SPACE = 44,
  MINUS = 45,
  EQUALS = 46,
  LEFTBRACKET = 47,
  RIGHTBRACKET = 48,
  BACKSLASH = 49,
  NONUSHASH = 50,
  SEMICOLON = 51,
  APOSTROPHE = 52,
  GRAVE = 53,
  COMMA = 54,
  PERIOD = 55,
  SLASH = 56,
  CAPSLOCK = 57,
  F1 = 58,
  F2 = 59,
  F3 = 60,
  F4 = 61,
  F5 = 62,
  F6 = 63,
  F7 = 64,
  F8 = 65,
  F9 = 66,
  F10 = 67,
  F11 = 68,
  F12 = 69,
  PRINTSCREEN = 70,
  SCROLLLOCK = 71,
  PAUSE = 72,
  INSERT = 73,
  HOME = 74,
  PAGEUP = 75,
  DELETE = 76,
  KEY_END = 77,
  PAGEDOWN = 78,
  RIGHT = 79,
  LEFT = 80,
  DOWN = 81,
  UP = 82,
  NUMLOCKCLEAR = 83,
  KP_DIVIDE = 84,
  KP_MULTIPLY = 85,
  KP_MINUS = 86,
  KP_PLUS = 87,
  KP_ENTER = 88,
  KP_1 = 89,
  KP_2 = 90,
  KP_3 = 91,
  KP_4 = 92,
  KP_5 = 93,
  KP_6 = 94,
  KP_7 = 95,
  KP_8 = 96,
  KP_9 = 97,
  KP_0 = 98,
  KP_PERIOD = 99,
  NONUSBACKSLASH = 100,
  APPLICATION = 101,
  POWER = 102,
  KP_EQUALS = 103,
  F13 = 104,
  F14 = 105,
  F15 = 106,
  F16 = 107,
  F17 = 108,
  F18 = 109,
  F19 = 110,
  F20 = 111,
  F21 = 112,
  F22 = 113,
  F23 = 114,
  F24 = 115,
  EXECUTE = 116,
  HELP = 117,
  MENU = 118,
  SELECT = 119,
  STOP = 120,
  AGAIN = 121,
  UNDO = 122,
  CUT = 123,
  COPY = 124,
  PASTE = 125,
  FIND = 126,
  MUTE = 127,
  VOLUMEUP = 128,
  VOLUMEDOWN = 129,
  LOCKINGCAPSLOCK = 130,
  LOCKINGNUMLOCK = 131,
  LOCKINGSCROLLLOCK = 132,
  KP_COMMA = 133,
  KP_EQUALSAS400 = 134,
  INTERNATIONAL1 = 135,
  INTERNATIONAL2 = 136,
  INTERNATIONAL3 = 137,
  INTERNATIONAL4 = 138,
  INTERNATIONAL5 = 139,
  INTERNATIONAL6 = 140,
  INTERNATIONAL7 = 141,
  INTERNATIONAL8 = 142,
  INTERNATIONAL9 = 143,
  LANG1 = 144,
  LANG2 = 145,
  LANG3 = 146,
  LANG4 = 147,
  LANG5 = 148,
  LANG6 = 149,
  LANG7 = 150,
  LANG8 = 151,
  LANG9 = 152,
  ALTERASE = 153,
  SYSREQ = 154,
  CANCEL = 155,
  CLEAR = 156,
  PRIOR = 157,
  RETURN2 = 158,
  SEPARATOR = 159,
  OUT = 160,
  OPER = 161,
  CLEARAGAIN = 162,
  CRSEL = 163,
  EXSEL = 164,
  KP_00 = 176,
  KP_000 = 177,
  THOUSANDSSEPARATOR = 178,
  DECIMALSEPARATOR = 179,
  CURRENCYUNIT = 180,
  CURRENCYSUBUNIT = 181,
  KP_LEFTPAREN = 182,
  KP_RIGHTPAREN = 183,
  KP_LEFTBRACE = 184,
  KP_RIGHTBRACE = 185,
  KP_TAB = 186,
  KP_BACKSPACE = 187,
  KP_A = 188,
  KP_B = 189,
  KP_C = 190,
  KP_D = 191,
  KP_E = 192,
  KP_F = 193,
  KP_XOR = 194,
  KP_POWER = 195,
  KP_PERCENT = 196,
  KP_LESS = 197,
  KP_GREATER = 198,
  KP_AMPERSAND = 199,
  KP_DBLAMPERSAND = 200,
  KP_VERTICALBAR = 201,
  KP_DBLVERTICALBAR = 202,
  KP_COLON = 203,
  KP_HASH = 204,
  KP_SPACE = 205,
  KP_AT = 206,
  KP_EXCLAM = 207,
  KP_MEMSTORE = 208,
  KP_MEMRECALL = 209,
  KP_MEMCLEAR = 210,
  KP_MEMADD = 211,
  KP_MEMSUBTRACT = 212,
  KP_MEMMULTIPLY = 213,
  KP_MEMDIVIDE = 214,
  KP_PLUSMINUS = 215,
  KP_CLEAR = 216,
  KP_CLEARENTRY = 217,
  KP_BINARY = 218,
  KP_OCTAL = 219,
  KP_DECIMAL = 220,
  KP_HEXADECIMAL = 221,
  LCTRL = 224,
  LSHIFT = 225,
  LALT = 226,
  LGUI = 227,
  RCTRL = 228,
  RSHIFT = 229,
  RALT = 230,
  RGUI = 231,
  MODE = 257,
  AUDIONEXT = 258,
  AUDIOPREV = 259,
  AUDIOSTOP = 260,
  AUDIOPLAY = 261,
  AUDIOMUTE = 262,
  MEDIASELECT = 263,
  WWW = 264,
  MAIL = 265,
  CALCULATOR = 266,
  COMPUTER = 267,
  AC_SEARCH = 268,
  AC_HOME = 269,
  AC_BACK = 270,
  AC_FORWARD = 271,
  AC_STOP = 272,
  AC_REFRESH = 273,
  AC_BOOKMARKS = 274,
  BRIGHTNESSDOWN = 275,
  BRIGHTNESSUP = 276,
  DISPLAYSWITCH = 277,
  KBDILLUMTOGGLE = 278,
  KBDILLUMDOWN = 279,
  KBDILLUMUP = 280,
  EJECT = 281,
  SLEEP = 282

  def InputCode.getName(code)
    case code
      when InputCode::UNKNOWN then "Unknown Key"
      when InputCode::A then "A"
      when InputCode::B then "B"
      when InputCode::C then "C"
      when InputCode::D then "D"
      when InputCode::E then "E"
      when InputCode::F then "F"
      when InputCode::G then "G"
      when InputCode::H then "H"
      when InputCode::I then "I"
      when InputCode::J then "J"
      when InputCode::K then "K"
      when InputCode::L then "L"
      when InputCode::M then "M"
      when InputCode::N then "N"
      when InputCode::O then "O"
      when InputCode::P then "P"
      when InputCode::Q then "Q"
      when InputCode::R then "R"
      when InputCode::S then "S"
      when InputCode::T then "T"
      when InputCode::U then "U"
      when InputCode::V then "V"
      when InputCode::W then "W"
      when InputCode::X then "X"
      when InputCode::Y then "Y"
      when InputCode::Z then "Z"
      when InputCode::NUM1 then "1"
      when InputCode::NUM2 then "2"
      when InputCode::NUM3 then "3"
      when InputCode::NUM4 then "4"
      when InputCode::NUM5 then "5"
      when InputCode::NUM6 then "6"
      when InputCode::NUM7 then "7"
      when InputCode::NUM8 then "8"
      when InputCode::NUM9 then "9"
      when InputCode::NUM0 then "0"
      when InputCode::RETURN then "Enter"
      when InputCode::ESCAPE then "Escape"
      when InputCode::BACKSPACE then "Backspace"
      when InputCode::TAB then "Tab"
      when InputCode::SPACE then "Space"
      when InputCode::MINUS then "-"
      when InputCode::EQUALS then "="
      when InputCode::LEFTBRACKET then "["
      when InputCode::RIGHTBRACKET then "]"
      when InputCode::BACKSLASH then "\\"
      when InputCode::NONUSHASH then "#"
      when InputCode::SEMICOLON then ";"
      when InputCode::APOSTROPHE then "'"
      when InputCode::GRAVE then "`"
      when InputCode::COMMA then ","
      when InputCode::PERIOD then "."
      when InputCode::SLASH then "/"
      when InputCode::CAPSLOCK then "Caps Lock"
      when InputCode::F1 then "F1"
      when InputCode::F2 then "F2"
      when InputCode::F3 then "F3"
      when InputCode::F4 then "F4"
      when InputCode::F5 then "F5"
      when InputCode::F6 then "F6"
      when InputCode::F7 then "F7"
      when InputCode::F8 then "F8"
      when InputCode::F9 then "F9"
      when InputCode::F10 then "F10"
      when InputCode::F11 then "F11"
      when InputCode::F12 then "F12"
      when InputCode::PRINTSCREEN then "PrintScreen"
      when InputCode::SCROLLLOCK then "Scroll Lock"
      when InputCode::PAUSE then "Pause"
      when InputCode::INSERT then "Insert"
      when InputCode::HOME then "Home"
      when InputCode::PAGEUP then "Page Up"
      when InputCode::DELETE then "Delete"
      when InputCode::KEY then "Key"
      when InputCode::PAGEDOWN then "Page Down"
      when InputCode::RIGHT then "Right Arrow"
      when InputCode::LEFT then "Left Arrow"
      when InputCode::DOWN then "Down Arrow"
      when InputCode::UP then "Up Arrow"
      when InputCode::NUMLOCKCLEAR then "Num Lock"
      when InputCode::KP_DIVIDE then "NumPad /"
      when InputCode::KP_MULTIPLY then "NumPad *"
      when InputCode::KP_MINUS then "NumPad -"
      when InputCode::KP_PLUS then "NumPad +"
      when InputCode::KP_ENTER then "NumPad Enter"
      when InputCode::KP_1 then "NumPad 1"
      when InputCode::KP_2 then "NumPad 2"
      when InputCode::KP_3 then "NumPad 3"
      when InputCode::KP_4 then "NumPad 4"
      when InputCode::KP_5 then "NumPad 5"
      when InputCode::KP_6 then "NumPad 6"
      when InputCode::KP_7 then "NumPad 7"
      when InputCode::KP_8 then "NumPad 8"
      when InputCode::KP_9 then "NumPad 9"
      when InputCode::KP_0 then "NumPad 0"
      when InputCode::KP_PERIOD then "NumPad ."
      when InputCode::NONUSBACKSLASH then "\\"
      when InputCode::APPLICATION then "Application"
      when InputCode::POWER then "Power"
      when InputCode::KP_EQUALS then "NumPad ="
      when InputCode::F13 then "F13"
      when InputCode::F14 then "F14"
      when InputCode::F15 then "F15"
      when InputCode::F16 then "F16"
      when InputCode::F17 then "F17"
      when InputCode::F18 then "F18"
      when InputCode::F19 then "F19"
      when InputCode::F20 then "F20"
      when InputCode::F21 then "F21"
      when InputCode::F22 then "F22"
      when InputCode::F23 then "F23"
      when InputCode::F24 then "F24"
      when InputCode::EXECUTE then "Execute"
      when InputCode::HELP then "Help"
      when InputCode::MENU then "Menu"
      when InputCode::SELECT then "Select"
      when InputCode::STOP then "Stop"
      when InputCode::AGAIN then "Again"
      when InputCode::UNDO then "Undo"
      when InputCode::CUT then "Cut"
      when InputCode::COPY then "Copy"
      when InputCode::PASTE then "Paste"
      when InputCode::FIND then "Find"
      when InputCode::MUTE then "Mute"
      when InputCode::VOLUMEUP then "Volume Up"
      when InputCode::VOLUMEDOWN then "Volume Down"
      when InputCode::LOCKINGCAPSLOCK then "Caps Lock"
      when InputCode::LOCKINGNUMLOCK then "Num Lock"
      when InputCode::LOCKINGSCROLLLOCK then "Scroll Lock"
      when InputCode::KP_COMMA then "NumPad ,"
      when InputCode::KP_EQUALSAS400 then "NumPad ="
      when InputCode::INTERNATIONAL1 then "Unknown Key"
      when InputCode::INTERNATIONAL2 then "Unknown Key"
      when InputCode::INTERNATIONAL3 then "Unknown Key"
      when InputCode::INTERNATIONAL4 then "Unknown Key"
      when InputCode::INTERNATIONAL5 then "Unknown Key"
      when InputCode::INTERNATIONAL6 then "Unknown Key"
      when InputCode::INTERNATIONAL7 then "Unknown Key"
      when InputCode::INTERNATIONAL8 then "Unknown Key"
      when InputCode::INTERNATIONAL9 then "Unknown Key"
      when InputCode::LANG1 then "Unknown Key"
      when InputCode::LANG2 then "Unknown Key"
      when InputCode::LANG3 then "Unknown Key"
      when InputCode::LANG4 then "Unknown Key"
      when InputCode::LANG5 then "Unknown Key"
      when InputCode::LANG6 then "Unknown Key"
      when InputCode::LANG7 then "Unknown Key"
      when InputCode::LANG8 then "Unknown Key"
      when InputCode::LANG9 then "Unknown Key"
      when InputCode::ALTERASE then "Alt Erase"
      when InputCode::SYSREQ then "SysReq"
      when InputCode::CANCEL then "Cancel"
      when InputCode::CLEAR then "Clear"
      when InputCode::PRIOR then "Prior"
      when InputCode::RETURN2 then "Enter 2"
      when InputCode::SEPARATOR then "Separator"
      when InputCode::OUT then "Out"
      when InputCode::OPER then "Oper"
      when InputCode::CLEARAGAIN then "Clear Again"
      when InputCode::CRSEL then "CRSel"
      when InputCode::EXSEL then "EXSel"
      when InputCode::KP_00 then "NumPad 00"
      when InputCode::KP_000 then "NumPad 000"
      when InputCode::THOUSANDSSEPARATOR then "Thousands Separator"
      when InputCode::DECIMALSEPARATOR then "Decimal Separator"
      when InputCode::CURRENCYUNIT then "Currency Unit"
      when InputCode::CURRENCYSUBUNIT then "Currency Subunit"
      when InputCode::KP_LEFTPAREN then "NumPad ("
      when InputCode::KP_RIGHTPAREN then "NumPad )"
      when InputCode::KP_LEFTBRACE then "NumPad ["
      when InputCode::KP_RIGHTBRACE then "NumPad ]"
      when InputCode::KP_TAB then "NumPad Tab"
      when InputCode::KP_BACKSPACE then "NumPad Backspace"
      when InputCode::KP_A then "NumPad A"
      when InputCode::KP_B then "NumPad B"
      when InputCode::KP_C then "NumPad C"
      when InputCode::KP_D then "NumPad D"
      when InputCode::KP_E then "NumPad E"
      when InputCode::KP_F then "NumPad F"
      when InputCode::KP_XOR then "NumPad XOR"
      when InputCode::KP_POWER then "NumPad Power"
      when InputCode::KP_PERCENT then "NumPad %"
      when InputCode::KP_LESS then "NumPad <"
      when InputCode::KP_GREATER then "NumPad >"
      when InputCode::KP_AMPERSAND then "NumPad &"
      when InputCode::KP_DBLAMPERSAND then "NumPad &"
      when InputCode::KP_VERTICALBAR then "NumPad |"
      when InputCode::KP_DBLVERTICALBAR then "NumPad |"
      when InputCode::KP_COLON then "NumPad :"
      when InputCode::KP_HASH then "NumPad #"
      when InputCode::KP_SPACE then "NumPad Space"
      when InputCode::KP_AT then "NumPad @"
      when InputCode::KP_EXCLAM then "NumPad !"
      when InputCode::KP_MEMSTORE then "NumPad Store"
      when InputCode::KP_MEMRECALL then "NumPad Recall"
      when InputCode::KP_MEMCLEAR then "NumPad Clear"
      when InputCode::KP_MEMADD then "NumPad Add"
      when InputCode::KP_MEMSUBTRACT then "NumPad Subtract"
      when InputCode::KP_MEMMULTIPLY then "NumPad Multiply"
      when InputCode::KP_MEMDIVIDE then "NumPad Divide"
      when InputCode::KP_PLUSMINUS then "NumPad +-"
      when InputCode::KP_CLEAR then "NumPad Clear"
      when InputCode::KP_CLEARENTRY then "NumPad Clear Entry"
      when InputCode::KP_BINARY then "NumPad Binary"
      when InputCode::KP_OCTAL then "NumPad Octal"
      when InputCode::KP_DECIMAL then "NumPad Decimal"
      when InputCode::KP_HEXADECIMAL then "NumPad Hex"
      when InputCode::LCTRL then "Left Ctrl"
      when InputCode::LSHIFT then "Left Shift"
      when InputCode::LALT then "Left Alt"
      when InputCode::LGUI then "Left GUI"
      when InputCode::RCTRL then "Right Ctrl"
      when InputCode::RSHIFT then "Right Shift"
      when InputCode::RALT then "Right Alt"
      when InputCode::RGUI then "Right GUI"
      when InputCode::MODE then "Mode"
      when InputCode::AUDIONEXT then "Audio Next"
      when InputCode::AUDIOPREV then "Audio Prev"
      when InputCode::AUDIOSTOP then "Audio Stop"
      when InputCode::AUDIOPLAY then "Audio Play"
      when InputCode::AUDIOMUTE then "Audio Mute"
      when InputCode::MEDIASELECT then "Media Select"
      when InputCode::WWW then "www"
      when InputCode::MAIL then "Mail"
      when InputCode::CALCULATOR then "Calculator"
      when InputCode::COMPUTER then "Computer"
      when InputCode::AC_SEARCH then "Search"
      when InputCode::AC_HOME then "Home"
      when InputCode::AC_BACK then "Back"
      when InputCode::AC_FORWARD then "Forward"
      when InputCode::AC_STOP then "Stop"
      when InputCode::AC_REFRESH then "Refresh"
      when InputCode::AC_BOOKMARKS then "Bookmarks"
      when InputCode::BRIGHTNESSDOWN then "Brightness Down"
      when InputCode::BRIGHTNESSUP then "Brightness Up"
      when InputCode::DISPLAYSWITCH then "Display Switch"
      when InputCode::KBDILLUMTOGGLE then "Illum Toggle"
      when InputCode::KBDILLUMDOWN then "Illum Down"
      when InputCode::KBDILLUMUP then "Illum Up"
      when InputCode::EJECT then "Eject"
      when InputCode::SLEEP then "Sleep"
    end
    return "Unknown Key"
  end

  module SourceType
    Invalid = 0,
    Key = 1,
    JButton = 2,
    JAxis = 3,
    JHat = 4
  end

  module AxisDir
    Negative = 0,
    Positive = 1
  end

  class Keybind
    attr_accessor :src_type
    attr_accessor :input_code
    attr_accessor :input_arg
    attr_accessor :target

    def initialize(src_type, input_code, input_arg, target)
      self.src_type = src_type
      self.input_code = input_code
      self.input_arg = input_arg
      self.target = target
    end

    def to_s
      keys = []
      keys[Input::UP] = "up"
      keys[Input::DOWN] = "down"
      keys[Input::RIGHT] = "right"
      keys[Input::LEFT] = "left"
      keys[Input::USE] = "use"
      keys[Input::BACK] = "back"
      keys[Input::ACTION] = "action"
      return _INTL("Type: {1}, Key: {2}, Arg: {3}, Trg: {4}",
        self.src_type, self.input_code, self.input_arg, (keys[self.target] rescue "nil"))
    end
  end

  def InputCode.read_keybinds_file(file)
    form_ver = file.read(4).unpack("L")[0]
    rgss_ver = file.read(4).unpack("L")[0]
    count = file.read(4).unpack("L")[0]
    keybinds = []
    for i in 0...count
      src_type = file.read(4).unpack("L")[0]
      input_code = file.read(4).unpack("L")[0]
      input_arg = file.read(4).unpack("L")[0]
      target = file.read(4).unpack("L")[0]
      keybinds.push(Keybind.new(src_type, input_code, input_arg, target))
    end
    return keybinds
  end

  def InputCode.read_keybinds
    keybinds = []
    begin
      dir = System.data_directory
      delim = dir[dir.length - 1]
      dir = dir[0...(dir.length - 1)]
      dir = dir[0..(dir.rindex("/") || dir.rindex("\\"))] + "Pokemon Vagabond" + delim
      keybinds_file = _INTL("{1}{2}",
        dir, "keybindings.mkxp1")
      File.open(keybinds_file, "r") do |file|
        keybinds = InputCode.read_keybinds_file(file)
      end
    rescue
      echo "Failed to load keybinds file. Loading default.\n"
      keybinds_file = _INTL("default_keys.mkxp1")
      File.open(keybinds_file, "r") do |file|
        keybinds = InputCode.read_keybinds_file(file)
      end
    end
    return keybinds
  end
end

module Input

  unless defined?(_press?)
    class << Input
      alias _press? press?
    end
  end

  unless defined?(_trigger?)
    class << Input
      alias _trigger? trigger?
    end
  end

  unless defined?(_repeat?)
    class << Input
      alias _repeat? repeat?
    end
  end

  def self.press?(input)
    input = $Keybinds.convert(input)
    return _press?(input)
  end

  def self.trigger?(input)
    input = $Keybinds.convert(input)
    return _trigger?(input)
  end

  def self.repeat?(input)
    input = $Keybinds.convert(input)
    return _repeat?(input)
  end

end

class KeybindList
  def initialize
    @keybinds = InputCode.read_keybinds
  end

  def convert(input, ab_swap = false)
    control_style = $PokemonSystem ? $PokemonSystem.control_style : 0
    if control_style == 0
      # Keyboard specific (Rotate A, S, D for better controller defaults)
      case input
      when Input::JUMPUP
        input = Input::JUMPDOWN
      when Input::JUMPDOWN
        input = Input::SPECIAL
      when Input::SPECIAL
        input = Input::JUMPUP
      end
    else
      # Controller specific (Make L and R be page up/down)
      case input
      when Input::JUMPUP
        input = Input::L
      when Input::JUMPDOWN
        input = Input::R
      when Input::SPECIAL # Shift like on keyboard
        input = Input::JUMPUP
      end
      if control_style == 1 && !ab_swap
        # Nintendo Specific (swap A/B and X/Y)
        case input
        when Input::USE
          input = Input::BACK
        when Input::BACK
          input = Input::USE
        when Input::ACTION
          input = Input::JUMPUP 
        when Input::JUMPUP
          input = Input::ACTION
        end
      end
    end
    return input
  end

  def key(input)
    input = convert(input, true)
    keybind = nil
    for k in @keybinds
      if k.target == input
        if k.src_type == 1
          if !keybind || k.input_code < keybind.input_code
            keybind = k
          end
        end
      end
    end
    if keybind
      InputCode.getName(keybind.input_code)
    end
    return "Unknown Input"
  end

  def rect(input)
    input = convert(input, true)
    keybind = nil
    src_type = 0
    control_style = $PokemonSystem ? $PokemonSystem.control_style : 0
    for k in @keybinds
      if k.target == input
        if control_style == 0 && k.src_type == 1
          if !keybind || k.input_code < keybind.input_code
            keybind = k
            src_type = k.src_type
          end
        elsif control_style > 0 && k.src_type == 2
          if !keybind || k.input_code < keybind.input_code
            keybind = k
            src_type = k.src_type
          end
        elsif control_style > 0 && k.src_type == 3
          # echoln _INTL("axis {1}", k.input_code)
        elsif control_style > 0 && k.src_type == 4
          # echoln _INTL("jhat {1}", k.input_code)
        end
      end
    end
    if keybind
      id = keybind.input_code
      y_offset = src_type <= 1 ? 0 : (28 * (16 + control_style * 2))
      return Rect.new((id%16)*28,y_offset+(id/16).floor*28,28,28)
    end
    return Rect.new(0, 0, 28, 28)
  end
end

$Keybinds = KeybindList.new